name: Build and Publish QEMU

on:
  schedule:
    - cron: '0 6 * * *'   # 06:00 UTC
    - cron: '0 18 * * *'  # 18:00 UTC
  workflow_dispatch:

concurrency:
  group: build
  cancel-in-progress: false

env:
  ARCH_GITLAB_API: https://gitlab.archlinux.org/api/v4/projects/archlinux%2Fpackaging%2Fpackages%2Fqemu

jobs:
  # ── Detect latest Arch QEMU tag (shared between both build jobs) ────────────
  get-version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
      needs_build: ${{ steps.check.outputs.needs_build }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest Arch QEMU tag
        id: get_tag
        run: |
          LATEST_TAG=$(curl -sf \
            "${ARCH_GITLAB_API}/repository/tags?order_by=version&sort=desc&per_page=1" \
            | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['name'])")
          echo "Latest Arch QEMU tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Check if already built
        id: check
        run: |
          LATEST="${{ steps.get_tag.outputs.tag }}"
          LAST="$(cat last_built_version.txt 2>/dev/null || echo '')"
          echo "Last built: '$LAST' | Latest: '$LATEST'"
          if [[ "$LAST" == "$LATEST" ]]; then
            echo "Already up to date, skipping build."
            echo "needs_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version detected, will build."
            echo "needs_build=true" >> "$GITHUB_OUTPUT"
          fi

  # ── Build job (runs twice in parallel, once per target) ─────────────────────
  build:
    needs: get-version
    if: needs.get-version.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false  # if one arch fails, let the other continue
      matrix:
        include:
          - target: znver4
            docker_image: cachyos/docker-makepkg-znver4
          - target: v3
            docker_image: cachyos/docker-makepkg-v3

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ── Download Arch PKGBUILD files at the latest tag ─────────────────────
      - name: Download Arch QEMU PKGBUILD
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          mkdir -p build

          FILES=$(curl -sf \
            "${ARCH_GITLAB_API}/repository/tree?ref=${TAG}" \
            | python3 -c "
          import sys, json
          for f in json.load(sys.stdin):
              if f['type'] == 'blob':
                  print(f['name'])
          ")

          echo "Files in Arch QEMU $TAG:"
          echo "$FILES"

          for FILE in $FILES; do
            ENC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${FILE}', safe=''))")
            curl -sfL "${ARCH_GITLAB_API}/repository/files/${ENC}/raw?ref=${TAG}" \
              -o "build/${FILE}"
            echo "  downloaded: $FILE"
          done

      # ── Download the custom patch ───────────────────────────────────────────
      - name: Download custom patch
        run: |
          curl -sfL \
            "https://raw.githubusercontent.com/cmspam/qemu-patched/main/qemu-all-in-one.patch" \
            -o build/qemu-all-in-one.patch
          echo "Patch downloaded."

      # ── Inject patch into PKGBUILD ──────────────────────────────────────────
      - name: Inject patch into PKGBUILD
        run: |
          cp inject_patch.sh build/
          chmod +x build/inject_patch.sh
          cd build && bash inject_patch.sh

      # ── Build using CachyOS docker container ───────────────────────────────
      - name: Build package
        run: |
          cd build
          docker run --rm \
            -e EXPORT_PKG=1 \
            -e SYNC_DATABASE=1 \
            -v "$PWD:/pkg" \
            "${{ matrix.docker_image }}"
          echo ""
          echo "=== Built packages ==="
          ls -lh *.pkg.tar.zst

      # ── Generate pacman database files ─────────────────────────────────────
      - name: Generate pacman database
        run: |
          REPO_NAME="qemu-patched-${{ matrix.target }}"
          mkdir -p /tmp/repo
          cp build/*.pkg.tar.zst /tmp/repo/

          docker run --rm \
            -v /tmp/repo:/repo \
            archlinux:latest \
            bash -c "
              pacman -Sy --noconfirm --needed pacman 2>&1 | tail -3
              cd /repo
              repo-add ${REPO_NAME}.db.tar.gz *.pkg.tar.zst
              ln -sf ${REPO_NAME}.db.tar.gz ${REPO_NAME}.db
              ln -sf ${REPO_NAME}.files.tar.gz ${REPO_NAME}.files
              echo '=== database files ==='
              ls -lh *.db* *.files*
            "

          echo "Database generated."

      # ── Upload versioned archival release ──────────────────────────────────
      - name: Create versioned release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSIONED_TAG="${TAG}-${{ matrix.target }}"

          # Remove any existing release with this versioned tag
          gh release delete "$VERSIONED_TAG" --yes 2>/dev/null || true
          git push origin ":refs/tags/$VERSIONED_TAG" 2>/dev/null || true

          gh release create "$VERSIONED_TAG" \
            --title "QEMU ${TAG} (${{ matrix.target }})" \
            --notes "Arch Linux QEMU \`${TAG}\` with [qemu-all-in-one.patch](https://github.com/cmspam/qemu-patched) applied.
          Built with: \`${{ matrix.docker_image }}\`" \
            build/*.pkg.tar.zst

          echo "Versioned release created: $VERSIONED_TAG"

      # ── Update the stable latest-<target> release ──────────────────────────
      # This is the release users' pacman.conf points at permanently.
      # It is deleted and recreated on every build so the URL never changes.
      - name: Update latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          LATEST_TAG="latest-${{ matrix.target }}"
          REPO_NAME="qemu-patched-${{ matrix.target }}"

          # Delete existing latest release and its tag
          gh release delete "$LATEST_TAG" --yes 2>/dev/null || true
          git push origin ":refs/tags/$LATEST_TAG" 2>/dev/null || true

          # Collect all files: packages + db files
          FILES=$(ls build/*.pkg.tar.zst)
          DB_FILES="/tmp/repo/${REPO_NAME}.db.tar.gz /tmp/repo/${REPO_NAME}.db \
                    /tmp/repo/${REPO_NAME}.files.tar.gz /tmp/repo/${REPO_NAME}.files"

          gh release create "$LATEST_TAG" \
            --title "QEMU latest (${{ matrix.target }}) — ${TAG}" \
            --notes "Latest build: Arch Linux QEMU \`${TAG}\` with [qemu-all-in-one.patch](https://github.com/cmspam/qemu-patched) applied.
          Built with: \`${{ matrix.docker_image }}\`

          ## pacman.conf

          \`\`\`ini
          [${REPO_NAME}]
          SigLevel = Optional
          Server = https://github.com/cmspam/qemu-patched/releases/download/${LATEST_TAG}
          \`\`\`" \
            $FILES $DB_FILES

          echo "Latest release updated: $LATEST_TAG → $TAG"

  # ── Record the built version after both jobs succeed ────────────────────────
  record-version:
    needs: [get-version, build]
    if: needs.get-version.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Record built version
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          echo "$TAG" > last_built_version.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_built_version.txt
          git commit -m "chore: record built version $TAG [skip ci]"
          git push

      - name: Summary
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          echo "### Build complete: QEMU $TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Target | Release |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| znver4 | [latest-znver4](https://github.com/cmspam/qemu-patched/releases/tag/latest-znver4) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| v3     | [latest-v3](https://github.com/cmspam/qemu-patched/releases/tag/latest-v3) |" >> "$GITHUB_STEP_SUMMARY"
