name: Build and Publish QEMU

on:
  schedule:
    - cron: '0 6 * * *'   # 06:00 UTC
    - cron: '0 18 * * *'  # 18:00 UTC
  workflow_dispatch:

concurrency:
  group: build
  cancel-in-progress: false

env:
  ARCH_GITLAB_API: https://gitlab.archlinux.org/api/v4/projects/archlinux%2Fpackaging%2Fpackages%2Fqemu

jobs:
  # ── Detect latest Arch QEMU tag ─────────────────────────────────────────────
  get-version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
      needs_build: ${{ steps.check.outputs.needs_build }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest Arch QEMU tag
        id: get_tag
        run: |
          LATEST_TAG=$(curl -sf \
            "${ARCH_GITLAB_API}/repository/tags?order_by=version&sort=desc&per_page=1" \
            | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['name'])")
          echo "Latest Arch QEMU tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Check if already built
        id: check
        run: |
          LATEST="${{ steps.get_tag.outputs.tag }}"
          LAST="$(cat last_built_version.txt 2>/dev/null || echo '')"
          echo "Last built: '$LAST' | Latest: '$LATEST'"
          if [[ "$LAST" == "$LATEST" ]]; then
            echo "Already up to date, skipping build."
            echo "needs_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version detected, will build."
            echo "needs_build=true" >> "$GITHUB_OUTPUT"
          fi

  # ── Build jobs (parallel, one per target) ───────────────────────────────────
  build:
    needs: get-version
    if: needs.get-version.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: znver4
            # Both targets use the v3 container since GitHub runners don't
            # support AVX-512 / znver4 instructions. For znver4 we override
            # CFLAGS/CXXFLAGS inside the PKGBUILD so the compiled output
            # targets Zen 4, even though the toolchain itself is v3.
            docker_image: cachyos/docker-makepkg-v3
            march_flag: "-march=znver4 -mtune=znver4"
          - target: v3
            docker_image: cachyos/docker-makepkg-v3
            march_flag: "-march=x86-64-v3 -mtune=generic"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ── Download Arch PKGBUILD files ────────────────────────────────────────
      - name: Download Arch QEMU PKGBUILD
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          mkdir -p build

          FILES=$(curl -sf \
            "${ARCH_GITLAB_API}/repository/tree?ref=${TAG}" \
            | python3 -c "
          import sys, json
          for f in json.load(sys.stdin):
              if f['type'] == 'blob':
                  print(f['name'])
          ")

          echo "Files in Arch QEMU $TAG:"
          echo "$FILES"

          for FILE in $FILES; do
            ENC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${FILE}', safe=''))")
            curl -sfL "${ARCH_GITLAB_API}/repository/files/${ENC}/raw?ref=${TAG}" \
              -o "build/${FILE}"
            echo "  downloaded: $FILE"
          done

      # ── Download the custom patch ────────────────────────────────────────────
      - name: Download custom patch
        run: |
          curl -sfL \
            "https://raw.githubusercontent.com/cmspam/qemu-patched/main/qemu-all-in-one.patch" \
            -o build/qemu-all-in-one.patch
          echo "Patch downloaded."

      # ── Inject custom patch into PKGBUILD ────────────────────────────────────
      - name: Inject patch into PKGBUILD
        run: |
          cp inject_patch.sh build/
          chmod +x build/inject_patch.sh
          cd build && bash inject_patch.sh
          echo ""
          echo "=== Verification ==="
          grep -n "qemu-all-in-one\|^prepare()\|^build()" PKGBUILD | head -20

      # ── Inject -march flags into PKGBUILD ────────────────────────────────────
      # Adds CFLAGS/CXXFLAGS overrides as the first lines of build() so the
      # compiler always targets the right architecture.
      - name: Inject march flags into PKGBUILD
        run: |
          MARCH="${{ matrix.march_flag }}"
          cd build
          perl -i -pe \
            "s|^(build\(\) \{)\$|\$1\n  export CFLAGS=\"\${CFLAGS} ${MARCH}\"\n  export CXXFLAGS=\"\${CXXFLAGS} ${MARCH}\"|" \
            PKGBUILD
          echo "=== march flags injected, build() now starts: ==="
          grep -A5 "^build()" PKGBUILD | head -8

      # ── Build using the CachyOS docker container ─────────────────────────────
      # --privileged avoids the kernel landlock sandbox error on GitHub runners.
      # We bake a keyring refresh into a new image layer using docker build so
      # the actual build runs with the normal /run.sh entrypoint as notroot,
      # exactly as the container is designed.
      - name: Build package
        run: |
          cd build

          echo '=== Building image with refreshed keyrings ==='
          DOCKER_IMAGE="${{ matrix.docker_image }}"

          docker build --build-arg BASE_IMAGE="${DOCKER_IMAGE}" -t qemu-build-ready - << 'DOCKERFILE'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}
          # Receive and trust the CachyOS signing key, then refresh keyrings.
          # This runs as root during image build, before notroot takes over.
          RUN pacman-key --recv-keys F3B607488DB35A47 --keyserver keyserver.ubuntu.com && \
              pacman-key --lsign-key F3B607488DB35A47 && \
              pacman -Sy --noconfirm archlinux-keyring && \
              pacman -U --noconfirm 'https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-keyring-20240331-1-any.pkg.tar.zst' && \
              pacman-key --populate archlinux cachyos
          DOCKERFILE

          echo '=== Starting build ==='
          docker run --rm \
            --privileged \
            -e EXPORT_PKG=1 \
            -e SYNC_DATABASE=1 \
            -v "$PWD:/pkg" \
            qemu-build-ready

          echo ""
          echo "=== Built packages ==="
          ls -lh *.pkg.tar.zst

      # ── Generate pacman database ─────────────────────────────────────────────
      - name: Generate pacman database
        run: |
          REPO_NAME="qemu-patched-${{ matrix.target }}"
          mkdir -p /tmp/repo
          cp build/*.pkg.tar.zst /tmp/repo/

          docker run --rm \
            --privileged \
            -v /tmp/repo:/repo \
            archlinux:latest \
            bash -c "
              pacman -Sy --noconfirm --needed pacman 2>&1 | tail -3
              cd /repo
              repo-add ${REPO_NAME}.db.tar.gz *.pkg.tar.zst
              ln -sf ${REPO_NAME}.db.tar.gz ${REPO_NAME}.db
              ln -sf ${REPO_NAME}.files.tar.gz ${REPO_NAME}.files
              echo '=== database files ==='
              ls -lh
            "

      # ── Create versioned archival release ────────────────────────────────────
      - name: Create versioned release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSIONED_TAG="${TAG}-${{ matrix.target }}"

          gh release delete "$VERSIONED_TAG" --yes 2>/dev/null || true
          git push origin ":refs/tags/$VERSIONED_TAG" 2>/dev/null || true

          gh release create "$VERSIONED_TAG" \
            --title "QEMU ${TAG} (${{ matrix.target }})" \
            --notes "Arch Linux QEMU \`${TAG}\` with [qemu-all-in-one.patch](https://github.com/cmspam/qemu-patched) applied.
          Target: \`${{ matrix.march_flag }}\` | Built with: \`${{ matrix.docker_image }}\`" \
            build/*.pkg.tar.zst

          echo "Versioned release created: $VERSIONED_TAG"

      # ── Update the stable latest-<target> release ────────────────────────────
      # This release is always recreated at the same tag so pacman.conf
      # Server URLs never need to change.
      - name: Update latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          LATEST_TAG="latest-${{ matrix.target }}"
          REPO_NAME="qemu-patched-${{ matrix.target }}"

          gh release delete "$LATEST_TAG" --yes 2>/dev/null || true
          git push origin ":refs/tags/$LATEST_TAG" 2>/dev/null || true

          gh release create "$LATEST_TAG" \
            --title "QEMU latest (${{ matrix.target }}) — ${TAG}" \
            --notes "Latest build: Arch Linux QEMU \`${TAG}\` with [qemu-all-in-one.patch](https://github.com/cmspam/qemu-patched) applied.
          Target: \`${{ matrix.march_flag }}\` | Built with: \`${{ matrix.docker_image }}\`

          ## pacman.conf

          \`\`\`ini
          [${REPO_NAME}]
          SigLevel = Optional
          Server = https://github.com/cmspam/qemu-patched/releases/download/${LATEST_TAG}
          \`\`\`" \
            build/*.pkg.tar.zst \
            /tmp/repo/${REPO_NAME}.db.tar.gz \
            /tmp/repo/${REPO_NAME}.db \
            /tmp/repo/${REPO_NAME}.files.tar.gz \
            /tmp/repo/${REPO_NAME}.files

          echo "Latest release updated: $LATEST_TAG → $TAG"

  # ── Record version after both jobs succeed ───────────────────────────────────
  record-version:
    needs: [get-version, build]
    if: needs.get-version.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Record built version
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          echo "$TAG" > last_built_version.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_built_version.txt
          git commit -m "chore: record built version $TAG [skip ci]"
          git push

      - name: Build summary
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          echo "### Build complete: QEMU $TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Target | Release |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| znver4 | [latest-znver4](https://github.com/cmspam/qemu-patched/releases/tag/latest-znver4) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| v3     | [latest-v3](https://github.com/cmspam/qemu-patched/releases/tag/latest-v3) |" >> "$GITHUB_STEP_SUMMARY"
